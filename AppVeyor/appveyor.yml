## AppVeyor configuration for Pure Data
#
# this automatically builds Pd for W32 using VisualStudio,
# whenever a new commit is pushed to github...
#   https://ci.appveyor.com/project/umlaeute/pure-data

environment:
  matrix:
  - platform: x86
    AFLAGS: "/D__i386__"
  - platform: x64
    AFLAGS: "/D__x86_64__"
  - platform: mingw-w64-i686
    cc_path: "C:\\msys64\\usr\\bin"
  - platform: mingw-w64-x86_64
    cc_path: "C:\\msys64\\usr\\bin"

matrix:
  allow_failures:
    - platform: x64

shallow_clone: true

init:
  - echo init
  - if not "%cc_path%"=="" (set "PATH=%PATH%;%cc_path%")
  - if "%platform:~0,1%"=="x" call "%VS120COMNTOOLS%\..\..\VC\vcvarsall.bat" %platform%
  - if "%platform:~0,1%"=="x" call "%ProgramFiles%\Microsoft SDKs\Windows\v7.1\Bin\SetEnv.cmd" /%platform%
  - if "%platform:~0,5%"=="mingw" pacman --noconfirm -S --needed %platform%-gcc %platform%-libtool autoconf automake make %platform%-pkg-config %platform%-ntldd

install:
  - echo install
  - mkdir -p bin

# the version included with the Pd binaries,
# is actually ftp://sourceware.org/pub/pthreads-win32/pthreads-dll-2002-03-02
  - curl -L ftp://sourceware.org/pub/pthreads-win32/pthreads-w32-2-9-1-release.zip -o pthreads.zip
  - 7z x -opthreads pthreads.zip  Pre-built.2/dll Pre-built.2/lib Pre-built.2/include
  - set pthreaddir="%APPVEYOR_BUILD_FOLDER%\\pthreads\\Pre-built.2"
  - cd "%pthreaddir%\\include" && copy "*.h" "%APPVEYOR_BUILD_FOLDER%\\src\\"
  - cd "%pthreaddir%\\dll\\%platform%" && copy "pthreadVC2.dll" "%APPVEYOR_BUILD_FOLDER%\\bin\\pthreadVC2.dll"
  - cd "%pthreaddir%\\lib\\%platform%" && copy "pthreadVC2.lib" "%APPVEYOR_BUILD_FOLDER%\\bin\\pthreadVC.lib"
  - cd "%APPVEYOR_BUILD_FOLDER%"

# asio
  - curl -L http://www.steinberg.net/sdk_downloads/asiosdk2.3.zip -o asiosdk2.3.zip
  - 7z x -oasio asiosdk2.3.zip
  - cd asio && REN ASIOSDK2.3 ASIOSDK
  - cd "%APPVEYOR_BUILD_FOLDER%"

build_script:
  - echo build_script
  - if "%platform:~0,1%"=="x" cd src
  - if "%platform:~0,1%"=="x" nmake /f makefile.msvc AFLAGS="%AFLAGS%"
  - cd "%APPVEYOR_BUILD_FOLDER%"
  - if "%platform:~0,5%"=="MinGW" ./autogen.sh
  - if "%platform:~0,5%"=="MinGW" ./configure
  - if "%platform:~0,5%"=="MinGW" make
  - if "%platform:~0,5%"=="MinGW" make app

test_script:
  - bin\pd.com -version

deploy: off

artifacts:
  - path: 'bin'
    name: Pure Data (bin %platform%)
    type: zip
